---
title: "Ejercicio Shell"
author: "Fernando Briseño"
date: '2022-06-12'
output: html_document
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(stringi)
library(tidyverse)
library(purrr)
library(zoo)
#devtools::install_github('Mikata-Project/ggthemr')

library(ggthemr)
library(spatstat)
library(shades)


library(extrafont)
# Ver https://github.com/wch/extrafont/issues/32
# remotes::install_version("Rttf2pt1", version = "1.3.8")
# font_import(paths = "/Users/ffbris/Library/Fonts", prompt = FALSE)
# 
# font.add("Gill_Sans_Nova", "/Users/ffbris/Library/Fonts/GillSansNova-Book.otf")
```


```{r}
ggthemr_reset()


set.seed(12345)
paleta_OIM_base <- c("#0033A0", 
                "#5B92E5", 
                "#FFB81C",
                "#5CB8B2",
                "#ff671f",
                "#d22630")

paleta_OIM <- c(paleta_OIM_base,
                brightness(paleta_OIM_base, 0.75),
                brightness(paleta_OIM_base, 0.5),
                brightness(paleta_OIM_base, 0.3))

OIM <- define_palette(
  swatch = paleta_OIM,
  gradient = c(lower = "#5B92E5", upper = "#0033A0"),
  background = "#ffffff",
  text = c("#444444", "#444444"),
  line = c("#696969", "#696969"),
  gridline = "#F5F5F5"
)

ggthemr(OIM)





```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:


Usamos este código para imprimir los nombres de los archivos. Se pudo haber hecho en R, pero decidí descargarlos desde la terminal. 

```{r eval = FALSE}
x <- character() 
for (i in 5:22){
  for (j in 1:4){
    year <- 2000 + i
    texto <- cat(sprintf("\ncurl -o %dtrim%d_csv.zip https://www.inegi.org.mx/contenidos/programas/enoe/15ymas/microdatos/%dtrim%d_csv.zip",year,j,year,j))
    x <- paste(x,texto)
  }
}
print(x)

```

## De CSV a R

Una vez que tenemos los CSV con el nombre homogeneizado (había que abrir los zip y poner en minúsculas), nos encargamos de pasarlo a RDS, que es más eficiente.
```{r, eval=FALSE}
# fnames <- list.files()
# files <- length(fnames)
# 
# for (i in 1:files){
#   name <- fnames[i]
#   name_RDS <- paste(stri_sub(name,-6,-5),
#                     "-",
#                     stri_sub(name,-7,-7),
#                               ".rds", sep = "")
#   file <- read.csv(name)
#   saveRDS(file,name_RDS)
# }
# 
# 


```

## Comprobar funcionamiento

Se prueba para un periodo en particular. Sale el mismo número que el tabulado de INEGI en línea.
```{r, eval = FALSE}
# prueba <- readRDS("19-3-47.rds")
# prueba2 <- readRDS("16-2.rds")
# prueba3 <- readRDS("22-1.rds")
# 
#   # file <- read.csv("sdemt421.csv")
#   # saveRDS(file,"21-4.rds")
# 
# 
# # INEGI dice que para pob ocupada, en UNIVERSO: Para el uso de las variables se debe aplicar el siguiente criterio: R_DEF= 00 y C;RES=1 o 3 y EDAD 15 a 98 AÑOS. https://www.inegi.org.mx/contenidos/programas/enoe/15ymas/doc/fd_c_bas_amp_15ymas.pdf (p. 18)
# prueba %>% filter(clase2 == 1, 
#                   R_DEF == 0, 
#                   (C_RES == 1 | C_RES == 3), 
#                   EDA >= 15, 
#                   EDA <= 98,
#                   RAMA_EST2 == 3
#                   ) %>% 
#   mutate(migrante = ifelse(L_NAC_C > 33, 1,0)) %>%
#   filter(migrante == 1) %>% 
#   summarise(total = sum(FAC)) %>% pull()
# 
# prueba %>% filter(CLASE2 == 1, 
#                   R_DEF == 0, 
#                   (C_RES == 1 | C_RES == 3), 
#                   EDA >= 15, 
#                   EDA <= 98,
#                   ) %>% 
#   mutate(migrante = ifelse(L_NAC_C > 33, 1,0)) %>%
#   group_by(migrante) %>% 
#   summarise(total = sum(FAC))


```




```{r}
# FUNCIONES

function.identificar <- function(df,x){
  cbind(df, TIEMPO=rep(x,nrow(df)))
  }

function.minus <- function(df){
  names(df) <- tolower(names(df))
  names(df) <- gsub(x = names(df), pattern = "_tri", replacement = "")  
  return(df)
}

function.total <- function(df) {
  df %>% filter(clase2 == 1, 
                  r_def == 0, 
                  (c_res == 1 | c_res == 3), 
                  eda >= 15, 
                  eda <= 98,
                  ) %>% 
   mutate(migrante = ifelse(l_nac_c > 33, TRUE,FALSE)) %>%
    group_by(rama, migrante, TIEMPO) %>%
  summarise(total.ocupada = sum(fac)) %>% ungroup()
}

function.migrante <- function(df) {
  df %>% filter(clase2 == 1, 
                  r_def == 0, 
                  (c_res == 1 | c_res == 3), 
                  eda >= 15, 
                  eda <= 98,
                  rama_est2 == 3
                  ) %>% 
  mutate(migrante = ifelse(l_nac_c > 33, TRUE,FALSE)) %>%
  group_by(migrante, ent, TIEMPO) %>%
  summarise(total.ocupada.manufactura = sum(fac)) %>% ungroup()
}

function.migrante.interno <- function(df) {
  df %>% filter(clase2 == 1, 
                  r_def == 0, 
                  (c_res == 1 | c_res == 3), 
                  eda >= 15, 
                  eda <= 98,
                  rama_est2 == 3
                  ) %>% 
  mutate(migrante.ext = ifelse(l_nac_c > 33, TRUE,FALSE),
         migrante.int = ifelse(l_nac_c != ent, TRUE, FALSE)) %>%
  group_by(migrante.ext, migrante.int, ent, TIEMPO) %>%
  summarise(total.ocupada.manufactura = sum(fac)) %>% ungroup()
}

function.migrante.sex <- function(df) {
  df %>% filter(clase2 == 1, 
                  r_def == 0, 
                  (c_res == 1 | c_res == 3), 
                  eda >= 15, 
                  eda <= 98,
                  rama_est2 == 3
                  ) %>% 
  mutate(migrante = ifelse(l_nac_c > 33, TRUE,FALSE)) %>%
  group_by(migrante, sex, TIEMPO) %>%
  summarise(total.ocupada.sex = sum(fac)) %>% ungroup()
}

function.migrante.jov <- function(df) {
  df %>% filter(clase1 == 1, 
                  r_def == 0, 
                  (c_res == 1 | c_res == 3), 
                  eda5c == 1
                  ) %>% 
  group_by(TIEMPO) %>%
  summarise(total.ocupada.jov = sum(fac)) %>% ungroup()
}

function.migrante.eda <- function(df) {
  df %>% filter(clase2 == 1, 
                  r_def == 0, 
                  (c_res == 1 | c_res == 3), 
                  eda >= 15, 
                  eda <= 98,
                  rama_est2 == 3
                  ) %>% 
  mutate(migrante = ifelse(l_nac_c > 33, TRUE,FALSE)) %>%
  group_by(migrante, eda7c, TIEMPO) %>% filter(migrante ==TRUE) %>% 
  summarise(total.ocupada.eda = sum(fac)) %>% ungroup()
}



function.migrante.eda2 <- function(df) {
  df %>% filter(clase2 == 1, 
                  r_def == 0, 
                  (c_res == 1 | c_res == 3), 
                  eda >= 15, 
                  eda <= 98,
                  rama_est2 == 3
                  ) %>% 
  mutate(migrante = ifelse(l_nac_c > 33, TRUE,FALSE)) %>% filter(migrante ==TRUE) %>% 
  group_by(TIEMPO) %>% 
  summarise(Media = weighted.mean(eda, fac), 
            Mediana = weighted.median(eda, fac),
            Cuartil_1 = weighted.quantile(eda, fac, prob = .25, na.rm= TRUE),
            Cuartil_3 = weighted.quantile(eda, fac, prob = .75, na.rm= TRUE))
}

function.migrante.origen <- function(df) {
  df %>% filter(clase2 == 1, 
                  r_def == 0, 
                  (c_res == 1 | c_res == 3), 
                  eda >= 15, 
                  eda <= 98,
                  rama_est2 == 3
                  ) %>% 
  mutate(migrante = ifelse(l_nac_c > 33, TRUE,FALSE)) %>%
  filter(migrante == TRUE) %>%
    # mutate(origen = ifelse(
    #   (l_nac_c >= 100 & l_nac_c < 200), "AFRICA",
    #   ifelse(
    #   (l_nac_c >= 200 & l_nac_c < 300), "AMERICA",
    #   ifelse(
    #     (l_nac_c >= 300 & l_nac_c < 400), "ASIA",
    #     ifelse(
    #       (l_nac_c >= 400 & l_nac_c < 500), "EUROPA","OTROS"
    #     )
    #   )
    #   )
    # ))%>%
  mutate(origen = l_nac_c) %>%
  group_by(origen, TIEMPO) %>%
  summarise(total.ocupada.origen = sum(fac)) %>% ungroup()
}

function.migrante.estado <- function(df) {
  df %>% filter(clase1 == 1, 
                  r_def == 0, 
                  (c_res == 1 | c_res == 3), 
                  eda >= 15, 
                  eda <= 98,
                  rama_est2 == 3
                  ) %>% 
  mutate(migrante = ifelse(l_nac_c > 33, TRUE,FALSE)  ) %>% 
  group_by(TIEMPO, ent, migrante) %>%
  summarise(total.ocupada.estado = sum(fac)) %>% ungroup()
}

function.migrante.esc <- function(df) {
  df %>% filter(clase2 == 1, 
                  r_def == 0, 
                  (c_res == 1 | c_res == 3), 
                  eda >= 15, 
                  eda <= 98,
                  rama_est2 == 3
                  ) %>% 
  mutate(migrante = ifelse(l_nac_c > 33, TRUE,FALSE)) %>% filter(migrante ==TRUE) %>% 
  group_by(TIEMPO) %>% 
  summarise(Media = weighted.mean(anios_esc, fac), 
            Mediana = weighted.median(anios_esc, fac, na.rm = TRUE),
            Cuartil_1 = weighted.quantile(anios_esc, fac, prob = .25, na.rm= TRUE),
            Cuartil_3 = weighted.quantile(anios_esc, fac, prob = .75, na.rm= TRUE))
}


function.migrante.niv.inst <- function(df) {
  df %>% filter(clase1 == 1, 
                  r_def == 0, 
                  (c_res == 1 | c_res == 3), 
                  eda >= 15, 
                  eda <= 98,
                  rama_est2 == 3
                  ) %>% 
  filter(l_nac_c > 33) %>%
  mutate( origen = l_nac_c )%>%
  group_by(TIEMPO, niv_ins, origen) %>%
  summarise(total.ocupada.estado = sum(fac)) %>% ungroup()
}
```




# Tareas de base de datos

```{r}

lista.df <- lapply(list.files(pattern = "*.rds"), readRDS)

fnames_fecha <- list.files(pattern = "*.rds") %>% 
  gsub(".rds","",.) %>% 
  gsub("-"," Q",.) %>%
  paste("20",., sep="") %>% 
  as.yearqtr("%Y Q%q") 

lista.df <- lapply(lista.df, function.minus)

lista.df <- mapply(function.identificar, lista.df, fnames_fecha)


# lista.df.prueba <- lista.df
# SE USARON PARA VERIFICACIONES
# lista.colnames <- lapply(lista.df, colnames)
# bind_rows(lapply(lista.colnames, as.data.frame.list)) 
```

# Población ocupada en general

```{r}
sectores_rama <- c("Agropecuario",
"Construcción",
"Industria manufacturera",
"Comercio",
"Servicio",
"Otros",
"No especificado")

df_rama <- data.frame(sectores = sectores_rama, rama = c(6,1,2,3,4,5,7))




lista.pob.ocup.total <- lapply(lista.df, function.total)

bd.ocupacion.total <- Reduce(full_join,lista.pob.ocup.total) %>% mutate(fecha = as.yearqtr(TIEMPO))
```





```{r}




bd.ocupacion.total %>% group_by(fecha, migrante) %>%
  summarise(Total = sum(total.ocupada)) %>% 
  ungroup() %>% 
  spread(migrante, Total) %>%
  rename(Migrante= 3, No.Migrante =2) %>%
  mutate(prop = Migrante/No.Migrante) %>%
    ggplot(aes(x=fecha, y=prop)) +
                        geom_line() + 
                         geom_smooth(alpha=.2, fill = "gray") + 
                        xlab("") + 
                        labs(y="Porcentaje", 
                             x = "Fecha", 
                             # title = "Proporción entre población migrante internacional y población \ntotal ocupada en la manufactura",
                             # subtitle = "2005-2022 Trimestral",
                             # caption = "Fuente: INEGI ENOE."
                             ) +
                        # theme_bw() + 
  scale_y_continuous(labels = scales::label_percent(decimal.mark = ",")) +          theme(text=element_text(size=10,  family="Gill Sans Nova Book"))

ggsave("plot.pob_migocupada_total_proporcion.svg", 
       device = "svg",
       height = 15,
       width = 24,
       units = "cm",
       dpi = 300)  

bd.ocupacion.total  %>% filter(migrante == TRUE) %>%
  group_by(rama, fecha) %>%   
  left_join(df_rama, by= "rama") %>%
  mutate(rama =as.factor(rama), Sectores = sectores, Total = total.ocupada)%>%
   filter(rama != 7)  %>%
      ggplot(aes(x=fecha, y=Total, fill= Sectores)) +
                        geom_bar(position="stack", stat="identity") + 
                        xlab("") + 
                        labs(y="Población ocupada", 
                             x = "Fecha", 
                             # title = "Proporción entre población migrante internacional y población \ntotal ocupada por sector",
                             # subtitle = "2005-2022 Trimestral"
                             ) +
                        # theme_bw() + 
  scale_y_continuous(labels = scales::label_number(decimal.mark = ",", big.mark = ".")) +          theme(text=element_text(size=10,  family="Gill Sans Nova Book"))

ggsave("plot.pob_migocupada_total_sector.svg", 
       device = "svg",
       height = 15,
       width = 24,
       units = "cm",
       dpi = 300)

bd.ocupacion.total %>% 
  group_by(rama, fecha) %>%   spread(migrante, total.ocupada) %>% 
  rename(Migrante= 5, No.Migrante =4) %>% mutate(prop = Migrante/(Migrante+No.Migrante)) %>%
  left_join(df_rama, by= "rama") %>%
  mutate(rama =as.factor(rama), Sectores = sectores)%>%
   filter(rama != 7)  %>%
      ggplot(aes(x=fecha, y=prop, group= Sectores, colour = Sectores)) +
                        geom_smooth(fill = "gray") + 
                        xlab("") + 
                        labs(y="Población ocupada", 
                             x = "Fecha", 
                             # title = "Proporción entre población migrante internacional y población \ntotal ocupada por sector",
                             # subtitle = "2005-2022 Trimestral",
                              caption = "Nota: Series suavizadas con método loess."
                             ) +
                        # theme_bw() + 
  scale_y_continuous(labels = scales::label_percent(decimal.mark = ",")) +          theme(text=element_text(size=10,  family="Gill Sans Nova Book"))

ggsave("plot.pob_migocupada_total_sector_proporcion.svg", 
       device = "svg",
       height = 15,
       width = 24,
       units = "cm",
       dpi = 300)

# bd.ocupacion.total %>% filter(fecha == "2021 Q4" & migrante == TRUE)  %>% 
#   group_by(rama, fecha) %>%
#   left_join(df_rama, by= "rama") %>%
#   mutate(rama =as.factor(rama), Sectores = sectores)



```


# Análisis sobre población migrante internacional

```{r}
lista.pob.ocup.mig <- lapply(lista.df, function.migrante)

bd.ocupacion <- Reduce(full_join,lista.pob.ocup.mig) %>% mutate(fecha = as.yearqtr(TIEMPO))
```


```{r}
bd.ocupacion %>% 
  group_by(fecha) %>% 
  summarise(Total = sum(total.ocupada.manufactura))%>%
  ggplot(aes(x=fecha, y=Total)) +
                        geom_line() + 
                        xlab("") + 
                        labs(y="Población ocupada", 
                             x = "Fecha", 
                             # title = "Población ocupada en la manufactura (total)",
                             # subtitle = "2005-2022 Trimestral",
                             # caption = "Fuente: INEGI ENOE."
                             ) +
                       # theme_bw() + 
  scale_y_continuous(labels = scales::label_number(suffix = "M", decimal.mark = ",", big.mark = ".", scale = 1e-6)) +
                        theme(text=element_text(size=10,  family="Gill Sans Nova Book"))

ggsave("plot.pob_migmanuf_total.svg", 
       device = "svg",
       height = 15,
       width = 24,
       units = "cm",
       dpi = 300)


bd.ocupacion %>% filter(migrante == TRUE) %>%
  group_by(fecha) %>% 
  summarise(Total = sum(total.ocupada.manufactura))%>%
  ggplot(aes(x=fecha, y=Total)) +
                        geom_line() + 
                         geom_smooth(alpha=.2, fill = "gray") + 
                        xlab("") + 
                        labs(y="Población ocupada", 
                             x = "Fecha", 
                             # title = "Población migrante internacional ocupada en la manufactura (total)",
                             # subtitle = "2005-2022 Trimestral",
                             # caption = "Fuente: INEGI ENOE."
                             ) +
                        # theme_bw() + 
  scale_y_continuous(labels = scales::label_number(decimal.mark = ",", big.mark = ".")) +          theme(text=element_text(size=10,  family="Gill Sans Nova Book"))

ggsave("plot.pob_migmanuf_total_mig.svg", 
       device = "svg",
       height = 15,
       width = 24,
       units = "cm",
       dpi = 300)


bd.ocupacion %>% group_by(fecha, migrante) %>%
  summarise(Total = sum(total.ocupada.manufactura)) %>% 
  ungroup() %>% 
  spread(migrante, Total) %>%
  rename(Migrante= 3, No.Migrante =2) %>%
  mutate(prop = Migrante/No.Migrante) %>%
    ggplot(aes(x=fecha, y=prop)) +
                        geom_line() + 
                         geom_smooth(alpha=.2, fill = "gray") + 
                        xlab("") + 
                        labs(y="Porcentaje", 
                             x = "Fecha", 
                             # title = "Proporción entre población migrante internacional y población \ntotal ocupada en la manufactura",
                             # subtitle = "2005-2022 Trimestral",
                             # caption = "Fuente: INEGI ENOE."
                             ) +
                        # theme_bw() + 
  scale_y_continuous(labels = scales::label_percent(decimal.mark = ",")) +          theme(text=element_text(size=10,  family="Gill Sans Nova Book"))

ggsave("plot.pob_migmanuf_total_proporcion.svg", 
       device = "svg",
       height = 15,
       width = 24,
       units = "cm",
       dpi = 300)  

```


```{r}
lista.pob.ocup.mig.orig <- lapply(lista.df, function.migrante.origen)

bd.ocupacion.orig <- Reduce(full_join,lista.pob.ocup.mig.orig) %>% mutate(fecha = as.yearqtr(TIEMPO))
```


```{r}
# bd.ocupacion.orig %>% mutate(origen = as.factor(origen)) %>% filter(fecha > 2014) %>%
#   group_by(fecha, origen) %>% 
#   summarise(Total = sum(total.ocupada.origen))%>%
#   ggplot(aes(x=fecha, y=Total, group = origen, colour = origen)) +
#                         geom_line(alpha=.5) + 
#                         geom_smooth(alpha=.5) +
#                         xlab("") + 
#                         labs(y="Población ocupada", 
#                              x = "Fecha", 
#                              # title = "Población migrante ocupada en la manufactura (por origen)",
#                              # subtitle = "2005-2022 Trimestral",
#                              caption = "Fuente: INEGI ENOE.") +
#                         theme_bw() + 
#   scale_y_continuous(labels = scales::label_number(decimal.mark = ",", big.mark = ".")) +
#                         theme(text=element_text(size=10,  family="Calibri"))
# 
# ggsave("plot.pob_migmanuf_edad.svg", 
#        device = "svg",
#        height = 15,
#        width = 24,
#        units = "cm",
#        dpi = 300)
# 
# 
# bd.ocupacion.orig %>% mutate(origen = as.factor(origen)) %>% filter(fecha > 2014) %>%
#   group_by(origen) %>% 
#   summarise(Total = median(total.ocupada.origen)) %>% arrange(desc(Total))
```

```{r}
guia <- as.data.frame(cbind(origen.n = as.character(c(221, 225, 200, 400, 300, 500, 100, 415)), nombre = c("EUA", "Guatemala", "Otros países América", "Otros países Europa", "Otros países África, Oceanía y Asia", "Otros países África, Oceanía y Asia", "Otros países África, Oceanía y Asia", "España")))

bd.ocupacion.orig <-   bd.ocupacion.orig %>% 
  mutate(origen.n= ifelse((fecha < "2012 Q2" & origen == 201), 221, as.character(origen)))  %>% arrange(desc(total.ocupada.origen)) %>% left_join(guia, by= "origen.n") 

bd.ocupacion.orig <- bd.ocupacion.orig %>% mutate(nombre = ifelse((is.na(nombre) & substr(origen.n,1,1)==2), "Otros países América", ifelse( (is.na(nombre) & substr(origen.n,1,1)==4),"Otros países Europa",ifelse( (is.na(nombre) & (substr(origen.n,1,1)== 3 | substr(origen.n,1,1)== 5 | substr(origen.n,1,1)== 1)),"Otros países África, Oceanía y Asia",nombre) ))) 
  
# ggthemr_reset()
```


```{r}
bd.ocupacion.orig %>% 
  mutate(origen = as.factor(origen.n)) %>% 
  filter(!is.na(nombre)) %>% 
  group_by(fecha, nombre) %>% 
  summarise(Total = sum(total.ocupada.origen))    %>% 
  mutate(Región = nombre) %>%
  ggplot(aes(x=fecha, y=Total, group = Región, colour = Región)) +
                        geom_smooth(alpha=.5, fill = "gray") + 
                        labs(y="Población ocupada", 
                             x = "Fecha", 
                             # title = "Población migrante ocupada en la manufactura (por origen)",
                             # subtitle = "2005-2022 Trimestral",
                             caption = "Nota: Series con suavización loess."
                             ) +
  scale_y_continuous(labels = scales::label_number(decimal.mark = ",", big.mark = ".")) +
                        theme(text=element_text(size=10,  family="Gill Sans Nova Book"))

ggsave("plot.pob_migmanuf_origen.svg", 
       device = "svg",
       height = 15,
       width = 24,
       units = "cm",
       dpi = 300)

# library(RColorBrewer)
# pal <- colorRampPalette(brewer.pal(12, "Set3"))
# pal(40)
# ggthemr('fresh')
# set_swatch(pal(40))

bd.ocupacion.orig %>% mutate(origen = as.factor(origen)) %>% filter(fecha > 2014) %>%
  group_by(origen) %>% 
  summarise(Total = median(total.ocupada.origen)) %>% arrange(desc(Total))
```




```{r, echo = FALSE, message=FALSE, results='hide'}

lista.pob.ocup.mig.eda <- lapply(lista.df, function.migrante.eda)

bd.ocupacion.eda <- Reduce(full_join,lista.pob.ocup.mig.eda) %>% mutate(fecha = as.yearqtr(TIEMPO))

edades <- c("De 15 a 19 años",
"De 20 a 29 años",
"De 30 a 39 años",
"De 40 a 49 años",
"De 50 a 59 años",
"De 60 años y más",
"Edad no especificado")

df_edades <- data.frame(edades, eda7c = c(1,2,3,4,5,6,7))
```


```{r}
bd.ocupacion.eda %>% #mutate(eda7c = as.factor(eda7c)) %>% 
  filter(fecha < 2022)  %>% 
  group_by(fecha, eda7c) %>% 
  summarise(Total = sum(total.ocupada.eda))%>%
  left_join(df_edades, by= "eda7c") %>%
  mutate(edad =as.factor(eda7c), Edades = edades)%>%
  ggplot(aes(x=fecha, y=Total, group= Edades, colour = Edades)) +
                        geom_smooth(alpha=.3, fill = "gray") + 
  # ggplot(aes(x=fecha, y=Total, fill = Edades)) +
  #                       geom_bar(position="stack", stat="identity") + 
  #                       xlab("") + 
                        labs(y="Población ocupada", 
                             x = "Fecha", 
                             # title = "Población migrante internacional ocupada por grupo de edad",
                             # subtitle = "2005-2022 Trimestral",
                              caption = "Nota: Suavización Loess."
                             ) +
                       # theme_bw() + 
  scale_y_continuous(labels = scales::label_number(decimal.mark = ",", big.mark = ".")) +
                        theme(text=element_text(size=10,  family="Gill Sans Nova Book"))

ggsave("plot.pob_migmanuf_edad.svg", 
       device = "svg",
       height = 15,
       width = 24,
       units = "cm",
       dpi = 300)

```


```{r, echo = FALSE, message=FALSE, results='hide'}
lista.pob.ocup.mig.eda2 <- lapply(lista.df, function.migrante.eda2)

bd.ocupacion.eda2 <- Reduce(full_join,lista.pob.ocup.mig.eda2) %>% mutate(fecha = as.yearqtr(TIEMPO))
```


```{r}
bd.ocupacion.eda2 %>% #mutate(eda7c = as.factor(eda7c)) %>% 
  filter(fecha < 2022)  %>% 
  ggplot(aes(x=fecha)) +  geom_line(aes(y=Media)) + 
                          geom_line(alpha=.5, aes(y=Mediana), linetype = "dotted") + 
                          geom_ribbon(aes(ymin = Cuartil_1, ymax =Cuartil_3), alpha = .2) +
  
  # ggplot(aes(x=fecha, y=Total, fill = Edades)) +
  #                       geom_bar(position="stack", stat="identity") + 
  #                       xlab("") + 
                        labs(y="Edad", 
                             x = "Fecha", 
                             # title = "Edad de la población migrante internacional ocupada en la manufactura",
                             # subtitle = "2005-2022 Trimestral",
                             caption = "Fuente: INEGI ENOE.\nÁrea sombreada = rango entre cuartiles. Línea punteada = mediana. Línea sólida = media.\nTodos los estadísticos son ponderados por los factores de expansión de la ENOE.") +
                       # theme_bw() + 
  scale_y_continuous(labels = scales::label_number(decimal.mark = ",", big.mark = ".")) +
                        theme(text=element_text(size=10,  family="Gill Sans Nova Book"))

ggsave("plot.pob_migmanuf_edad2.svg", 
       device = "svg",
       height = 15,
       width = 24,
       units = "cm",
       dpi = 300)

```




```{r, message=FALSE, results='hide'}
function.migrante.ing <- function(df) {
  df %>% filter(clase2 == 1, 
                  r_def == 0, 
                  (c_res == 1 | c_res == 3), 
                  eda >= 15, 
                  eda <= 98,
                  rama_est2 == 3
                  ) %>% 
  mutate(migrante = ifelse(l_nac_c > 33, TRUE,FALSE)) %>% filter(migrante ==TRUE) %>% 
  group_by(TIEMPO) %>% 
  summarise(Media = weighted.mean(ingocup, fac), 
            Mediana = weighted.median(ingocup, fac, na.rm = TRUE),
            Cuartil_1 = weighted.quantile(ingocup, fac, prob = .25, na.rm= TRUE),
            Cuartil_3 = weighted.quantile(ingocup, fac, prob = .75, na.rm= TRUE))
}

lista.pob.ocup.mig.ing <- lapply(lista.df, function.migrante.ing)

bd.ocupacion.ing <- Reduce(full_join,lista.pob.ocup.mig.ing) %>% mutate(fecha = as.yearqtr(TIEMPO))
```


```{r}

bd.ocupacion.ing %>% #mutate(eda7c = as.factor(eda7c)) %>% 
  filter(fecha < 2022)  %>% 
  ggplot(aes(x=fecha)) +
                          geom_line(aes(y=Media)) + 
                          geom_line(alpha=.5, aes(y=Mediana), linetype = "dotted") + 
                          geom_ribbon(aes(ymin = Cuartil_1, ymax =Cuartil_3), alpha = .2) +
  
  # ggplot(aes(x=fecha, y=Total, fill = Edades)) +
  #                       geom_bar(position="stack", stat="identity") + 
  #                       xlab("") + 
                        labs(y="Ingreso mensual", 
                             x = "Fecha", 
                             # title = "Ingreso mensual de la población migrante internacional ocupada \nen la manufactura",
                             # subtitle = "2005-2022 Trimestral",
                             caption = "Fuente: INEGI ENOE.\nÁrea sombreada = rango entre cuartiles. Línea punteada = mediana. Línea sólida = media.\nTodos los estadísticos son ponderados por los factores de expansión de la ENOE.") + ylim(NA, 15000) +
                       # theme_bw() + 
  scale_y_continuous(labels = scales::label_number(decimal.mark = ",", big.mark = ".")) +
                        theme(text=element_text(size=10,  family="Gill Sans Nova Book"))


ggsave("plot.pob_migmanuf_ingreso.svg", 
       device = "svg",
       height = 15,
       width = 24,
       units = "cm",
       dpi = 300)

# Calculos solicitados
bd.ocupacion.ing %>% #mutate(eda7c = as.factor(eda7c)) %>%
  filter(fecha < 2022)  %>% summarise(Media = mean(Media), Mediana = mean(Mediana))

bd.ocupacion.ing %>% #mutate(eda7c = as.factor(eda7c)) %>%
  filter(fecha == "2021 Q4")
```



```{r, message=FALSE}


lista.pob.ocup.mig.esc <- lapply(lista.df, function.migrante.esc)

bd.ocupacion.esc <- Reduce(full_join,lista.pob.ocup.mig.esc) %>% mutate(fecha = as.yearqtr(TIEMPO))
```


```{r}
bd.ocupacion.esc %>% #mutate(eda7c = as.factor(eda7c)) %>% 
  filter(fecha < 2022)  %>% 
  ggplot(aes(x=fecha)) +
                          geom_line(aes(y=Media)) + 
                          geom_line(alpha=.5, aes(y=Mediana), linetype = "dotted") + 
                          geom_ribbon(aes(ymin = Cuartil_1, ymax =Cuartil_3), alpha = .2) +
  
  # ggplot(aes(x=fecha, y=Total, fill = Edades)) +
  #                       geom_bar(position="stack", stat="identity") + 
  #                       xlab("") + 
                        labs(y="Años de escolaridad", 
                             x = "Fecha", 
                             # title = "Años de escolaridad de la población migrante internacional ocupada \nen la manufactura",
                             # subtitle = "2005-2022 Trimestral",
                             caption = "Área sombreada = rango entre cuartiles. Línea punteada = mediana. Línea sólida = media.\nTodos los estadísticos son ponderados por los factores de expansión de la ENOE.") + ylim(NA, 15000) +
                       # theme_bw() + 
  scale_y_continuous(labels = scales::label_number(decimal.mark = ",", big.mark = ".")) +
                        theme(text=element_text(size=10,  family="Gill Sans Nova Book"))

ggsave("plot.pob_migmanuf_escolaridad.svg", 
       device = "svg",
       height = 15,
       width = 24,
       units = "cm",
       dpi = 300)

bd.ocupacion.esc %>% #mutate(eda7c = as.factor(eda7c)) %>% 
  filter(fecha < 2022)  %>% summarise(Media = mean(Media), Mediana = mean(Mediana)) 

bd.ocupacion.esc %>% #mutate(eda7c = as.factor(eda7c)) %>% 
  filter(fecha == 2021)  
```

# Nivel de instrucción
```{r}
lista.pob.ocup.mig.niv.inst <- lapply(lista.df, function.migrante.niv.inst)

bd.ocupacion.niv.inst <- Reduce(full_join,lista.pob.ocup.mig.niv.inst) %>% mutate(fecha = as.yearqtr(TIEMPO))
```

```{r}

guia <- as.data.frame(cbind(origen.n = as.character(c(221, 225, 200, 400, 300, 500, 100, 415)), nombre = c("EUA", "Guatemala", "Otros países América", "Otros países Europa", "Otros países África, Oceanía y Asia", "Otros países África, Oceanía y Asia", "Otros países África, Oceanía y Asia", "España")))

bd.ocupacion.niv.inst <-   bd.ocupacion.niv.inst  %>% 
  mutate(origen.n= ifelse((fecha < "2012 Q2" & origen == 201), 221, as.character(origen)))  %>% arrange(desc(total.ocupada.estado)) %>% left_join(guia, by= "origen.n") 

bd.ocupacion.niv.inst <- bd.ocupacion.niv.inst %>% mutate(nombre = ifelse((is.na(nombre) & substr(origen.n,1,1)==2), "Otros países América", ifelse( (is.na(nombre) & substr(origen.n,1,1)==4),"Otros países Europa",ifelse( (is.na(nombre) & (substr(origen.n,1,1)== 3 | substr(origen.n,1,1)== 5 | substr(origen.n,1,1)== 1)),"Otros países África, Oceanía y Asia",nombre) ))) 


bd.ocupacion.niv.inst  %>% 
  group_by(niv_ins, fecha) %>%   mutate(EUA = ifelse(nombre == "EUA","TRUE","FALSE")) %>% filter(EUA == TRUE) %>%
    mutate(Niv_inst = as.factor(niv_ins), Total = total.ocupada.estado)%>%
      ggplot(aes(x=fecha, y=Total, fill= Niv_inst)) +
                        geom_bar(position="fill", stat="identity") + 
                        xlab("") + 
                        labs(y="Población ocupada", 
                             x = "Fecha", 
                             # title = "Proporción entre población migrante internacional y población \ntotal ocupada por sector",
                             # subtitle = "2005-2022 Trimestral"
                             ) +
                        # theme_bw() + 
  scale_y_continuous(labels = scales::label_number(decimal.mark = ",", big.mark = ".")) +          theme(text=element_text(size=10,  family="Gill Sans Nova Book"))

bd.ocupacion.niv.inst  %>% 
  group_by(niv_ins, fecha) %>%   mutate(EUA = ifelse(nombre == "EUA","TRUE","FALSE")) %>% filter(EUA == FALSE) %>%
    mutate(Niv_inst = as.factor(niv_ins), Total = total.ocupada.estado)%>%
      ggplot(aes(x=fecha, y=Total, fill= Niv_inst)) +
                        geom_bar(position="fill", stat="identity") + 
                        xlab("") + 
                        labs(y="Población ocupada", 
                             x = "Fecha", 
                             # title = "Proporción entre población migrante internacional y población \ntotal ocupada por sector",
                             # subtitle = "2005-2022 Trimestral"
                             ) +
                        # theme_bw() + 
  scale_y_continuous(labels = scales::label_number(decimal.mark = ",", big.mark = ".")) +          theme(text=element_text(size=10,  family="Gill Sans Nova Book"))



```
```{r}

```


# Estatus laboral

```{r, message=FALSE}
sectores_MH <- c(
"Trabajadores subordinados y remunerados Asalariados INFORMALES",
"Trabajadores subordinados y remunerados Asalariados FORMALES",
"Trabajadores subordinados y remunerados Con percepciones no salariales INFORMALES",
"Trabajadores subordinados y remunerados con percepciones no salariales FORMALES",
"Empleadores INFORMAL",
"Empleadores FORMAL",
"Trabajadores por cuenta propia INFORMAL",
"Trabajadores por cuenta propia FORMAL",
"Trabajadores no Remunerados", 
"Trabajadores no Remunerados FORMAL"
)

sectores_MH_resum <- c(
"Trabajadores subordinados y remunerados \nAsalariados INFORMALES",
"Trabajadores subordinados y remunerados \nAsalariados FORMALES",
"Trabajadores subordinados y remunerados \ncon percepciones no salariales INFORMALES",
"Trabajadores subordinados y remunerados \ncon percepciones no salariales FORMALES",
"Empleadores",
"Empleadores",
"Trabajadores por cuenta propia",
"Trabajadores por cuenta propia",
"Trabajadores no Remunerados", 
"Trabajadores no Remunerados"
)


formal_informal <- c("Informales",
                     "Formales",
                     "Informales",
                     "Formales",
                     "Informales",
                     "Formales",
                     "Informales",
                     "Formales",
                     "Informales",
                     "Formales")

df_MH <- data.frame(sectores = sectores_MH, sectores_MH_resum, formal_informal, mh_col = c(1,2,3,4,5,6,7,8,9,10))


function.mh <- function(df) {
  df %>% filter(clase2 == 1, 
                  r_def == 0, 
                  (c_res == 1 | c_res == 3), 
                  eda >= 15, 
                  eda <= 98,
                  rama_est2 == 3
                  ) %>% 
   mutate(migrante = ifelse(l_nac_c > 33, TRUE,FALSE)) %>% filter(migrante == 1) %>%
    group_by(mh_col, migrante, TIEMPO) %>%
  summarise(total.ocupada = sum(fac)) %>% ungroup()
}

lista.pob.ocup.mh <- lapply(lista.df, function.mh)

bd.ocupacion.mh <- Reduce(full_join,lista.pob.ocup.mh) %>% mutate(fecha = as.yearqtr(TIEMPO))
```


```{r}
bd.ocupacion.mh %>% filter(fecha < 2022)  %>% 
  group_by(mh_col, fecha) %>% 
  summarise(Total = sum(total.ocupada)) %>% 
  left_join(df_MH, by= "mh_col") %>%
  mutate(Formal = formal_informal)%>%
  ggplot(aes(x=fecha, y=Total, fill = Formal)) +
                        geom_bar(position="stack", stat="identity") + 
                        xlab("") + 
                        labs(y="Población ocupada", 
                             x = "Fecha", 
                             # title = "Población ocupada migrante internacional en manufactura \nformal vs informal",
                             # subtitle = "2005-2022 Trimestral",
                             # caption = "Fuente: INEGI ENOE."
                             ) +
                       # theme_bw() + 
  scale_y_continuous(labels = scales::label_number(decimal.mark = ",", big.mark = ".")) +
                        theme(text=element_text(size=10,  family="Gill Sans Nova Book"))

ggsave("plot.pob_migmanuf_formalinformal.svg", 
       device = "svg",
       height = 15,
       width = 24,
       units = "cm",
       dpi = 300)

bd.ocupacion.mh %>% filter(fecha < 2022)  %>% 
  group_by(mh_col, fecha) %>% 
  summarise(Total = sum(total.ocupada)) %>% 
  left_join(df_MH, by= "mh_col") %>%
  mutate(Formal = formal_informal)%>% 
  group_by(fecha, Formal) %>% summarise(Total =sum(Total)) %>%
  spread(Formal, Total) %>%
  mutate(Prop = Informales / (Formales + Informales))  %>% 
  ggplot(aes(x=fecha, y=Prop)) +
                        geom_line() + 
  geom_smooth(fill = "Gray") +
                        xlab("") + 
                        labs(y="Población ocupada informal como % del total", 
                             x = "Fecha", 
                             # title = "Población ocupada migrante internacional en manufactura \nformal vs informal",
                             # subtitle = "2005-2022 Trimestral",
                             # caption = "Fuente: INEGI ENOE."
                             ) +
                       # theme_bw() + 
  scale_y_continuous(labels = scales::label_percent(decimal.mark = ",")) +
                        theme(text=element_text(size=10,  family="Gill Sans Nova Book"))

ggsave("plot.pob_migmanuf_formalinformal_porcentaje.svg", 
       device = "svg",
       height = 15,
       width = 24,
       units = "cm",
       dpi = 300)


bd.ocupacion.mh %>% filter(fecha < 2022)  %>% 
  group_by(mh_col, fecha) %>% 
  summarise(Total = sum(total.ocupada)) %>% 
  left_join(df_MH, by= "mh_col") %>%
  mutate(Clasificacion = sectores_MH_resum)%>%
  ggplot(aes(x=fecha, y=Total, fill = Clasificacion)) +
                        geom_bar(position="fill", stat="identity", alpha = 0.75) + 
                        xlab("") + 
                        labs(y="Población ocupada", 
                             x = "Fecha", 
                             # title = "Población ocupada migrante internacional en manufactura \npor sectores de matriz de Hussmans",
                             # subtitle = "2005-2022 Trimestral",
                             # caption = "Fuente: INEGI ENOE."
                             ) +
                       # theme_bw() + 
  scale_y_continuous(labels = scales::label_percent(decimal.mark = ",", big.mark = ".")) +
                        theme(text=element_text(size=10,  family="Gill Sans Nova Book")) +
  theme(legend.position="bottom")

ggsave("plot.pob_migmanuf_tipoempleo.svg", 
       device = "svg",
       height = 15,
       width = 24,
       units = "cm",
       dpi = 300)

```


```{r, message=FALSE}
lista.pob.ocup.mig.sex <- lapply(lista.df, function.migrante.sex)

bd.ocupacion.sex <- Reduce(full_join,lista.pob.ocup.mig.sex) %>% mutate(fecha = as.yearqtr(TIEMPO))

```


```{r}
graf_pmom_sexo <- bd.ocupacion.sex %>% filter(migrante == TRUE) %>% mutate(sexo = as.factor(sex))%>%
  group_by(fecha, sexo) %>% 
  summarise(Total = sum(total.ocupada.sex))%>%
  mutate(sexo = ifelse(sexo ==1, "Hombre", "Mujer"))%>%
  ggplot(aes(x=fecha, y=Total, group = sexo, colour = sexo)) +
                        geom_line() + 
                        geom_smooth(fill = "light gray") +
                        xlab("") + 
                        labs(y="Población ocupada", 
                             x = "Fecha", 
                             # title = "Población migrante ocupada en la manufactura (por sexo)",
                             # subtitle = "2005-2022 Trimestral",
                             # caption = "Fuente: INEGI ENOE."
                             ) +
  scale_y_continuous(labels = scales::label_number(decimal.mark = ",", big.mark = ".")) +
                        theme(text=element_text(size=10,  family="Gill Sans Nova Book"))

ggsave("plot.pob_migmanuf_sexo.svg", 
       device = "svg",
       height = 15,
       width = 24,
       units = "cm",
       dpi = 300)

```

```{r, message=FALSE}
lista.pob.ocup.mig.int <- lapply(lista.df, function.migrante.interno)

bd.ocupacion.int <- Reduce(full_join,lista.pob.ocup.mig.int) %>% mutate(fecha = as.yearqtr(TIEMPO))
```


```{r}
bd.ocupacion.int %>% filter(migrante.ext == FALSE & migrante.int == TRUE) %>%
  group_by(fecha, migrante.int) %>% 
  summarise(Total = sum(total.ocupada.manufactura)) %>% 
  ggplot(aes(x=fecha, y=Total)) +
                        geom_line() + 
                        xlab("") + 
                        labs(y="Población ocupada", 
                             x = "Fecha", 
                             # title = "Personas migrantes nacionales ocupadas en la manufactura (total)",
                             # subtitle = "2005-2022 Trimestral",
                             caption = "Fuente: INEGI ENOE") +
                       # theme_bw() + 
  scale_y_continuous(labels = scales::label_number(suffix = "M", decimal.mark = ",", big.mark = ".", scale = 1e-6)) +
                        theme(text=element_text(size=10,  family="Gill Sans Nova Book"))

ggsave("plot.pob_mig_interna_total.svg", 
       device = "svg",
       height = 15,
       width = 24,
       units = "cm",
       dpi = 300)


bd.ocupacion.int %>% filter(migrante.ext == FALSE) %>%
  mutate(migrante.int2 = ifelse(migrante.int == TRUE, "SI", "NO")) %>%
  group_by(fecha, migrante.int2) %>% 
  summarise(Total = sum(total.ocupada.manufactura)) %>% 
  spread(migrante.int2, Total) %>% 
  mutate(Porc = SI / (SI + NO)) %>% 
  ggplot(aes(x=fecha, y=Porc)) +
                        geom_line() + 
                        xlab("") + 
                        labs(y="Porcentaje", 
                             x = "Fecha", 
                             # title = "Personas migrantes nacionales como proporción del total\nocupadas en la manufactura",
                             # subtitle = "2005-2022 Trimestral",
                             # caption = "Fuente: INEGI ENOE"
                             ) + 
                       # theme_bw() + 
  scale_y_continuous(labels = scales::label_percent(decimal.mark = ","), limits = c(0,.3)) +
                        theme(text=element_text(size=10,  family="Gill Sans Nova Book"))

ggsave("plot.pob_mig_interna_porporcion.svg", 
       device = "svg",
       height = 15,
       width = 24,
       units = "cm",
       dpi = 300)

```

```{r, message=FALSE}
lista.pob.ocup.estado <- lapply(lista.df, function.migrante.estado)

bd.ocupacion.estado <- Reduce(full_join,lista.pob.ocup.estado) %>% mutate(fecha = as.yearqtr(TIEMPO))

df_estado <- as.data.frame(cbind(seq(1,32), 
      c("Ags.","BC","BCS","Camp.","Coah.","Col.","Chis.","Chih.","CDMX","Dgo.","Gto.","Gro.","Hgo.","Jal.","Mex.","Mich.","Mor.","Nay.","NL","Oax.","Pue.","Qro.","Q. Roo","SLP","Sin.","Son.","Tab.","Tamps.","Tlax.","Ver.","Yuc.","Zac."),
      c("Centro-norte","Noreste","Noreste","Peninsula","Norte","Occidente","Sur","Noreste","Centro","Noreste","Centro-norte","Sur","Golfo","Occidente","Centro","Occidente","Centro","Occidente","Norte","Sur","Golfo","Centro-norte","Peninsula","Centro-norte","Noreste","Noreste","Peninsula","Norte","Golfo","Golfo","Peninsula","Centro-norte"
      )) )

colnames(df_estado) <- c("ent", "entidad", "region")
df_estado$ent <- as.integer(df_estado$ent)
```


```{r}
bd.ocupacion.estado %>% filter(fecha < 2022, migrante == TRUE)  %>% 
  group_by(ent, fecha) %>% 
  summarise(Total = sum(total.ocupada.estado)) %>% 
  left_join(df_estado, by= "ent") %>%
  mutate(ent =as.factor(ent)) %>%
  ggplot(aes(x=fecha, y=Total)) +
                        geom_line() + 
                        xlab("") + 
                        labs(y="Población migrante internacional ocupada", 
                             x = "Fecha", 
                             # title = "Población migrante internacional ocupada por entidad",
                             # subtitle = "2005-2022 Trimestral",
                             # caption = "Fuente: INEGI ENOE"
                             ) +
  facet_wrap("entidad", ncol(4)) +
                       # theme_bw() + 
  scale_y_continuous(labels = scales::label_number(decimal.mark = ",", big.mark = ".", suffix = "mil", scale = 1e-3)) +
                        theme(text=element_text(size=10,  family="Gill Sans Nova Book"))

ggsave("plot.pob_mig_int_por_estado.svg", 
       device = "svg",
       height = 25,
       width = 24,
       units = "cm",
       dpi = 300)


plot.pob_mig_int_por_estado <- bd.ocupacion.estado %>% filter(fecha < 2022, migrante == TRUE)  %>% 
  group_by(ent, fecha) %>% 
  summarise(Total = sum(total.ocupada.estado)) %>% 
  left_join(df_estado, by= "ent") %>%
   group_by(region, fecha) %>% 
  summarise(Total = sum(Total)) %>% 
  ggplot(aes(x=fecha, y=Total)) +
                        geom_line() + 
                        xlab("") + 
                        labs(y="Población migrante internacional ocupada", 
                             x = "Fecha", 
                             caption = "Fuente: INEGI ENOE. Notas: 2005-2022 Trimestral") +
  facet_wrap("region") +
                       # theme_bw() + 
  scale_y_continuous(labels = scales::label_number(decimal.mark = ",", big.mark = ".", suffix = "mil", scale = 1e-3)) +
                        theme(text=element_text(size=10,  family="Gill Sans Nova Book")) 

ggsave("plot.pob_mig_int_por_region.svg", 
       device = "svg",
       height = 20,
       width = 20,
       units = "cm",
       dpi = 300)

```

```{r}
function.migrante.jov <- function(df) {
  df %>% filter(clase1 == 1, 
                  r_def == 0, 
                  (c_res == 1 | c_res == 3), 
                  eda5c == 1
                  ) %>% 
  group_by(TIEMPO) %>%
  summarise(total.ocupada.jov = sum(fac)) %>% ungroup()
}

lista.migrante.jov <- lapply(lista.df, function.migrante.jov)

bd.ocupacion.jov <- Reduce(full_join,lista.migrante.jov) %>% mutate(fecha = as.yearqtr(TIEMPO))


# saveRDS(bd.ocupacion.jov, "bd_ocupacion_jov.rds")
# lista.df <- lista.df[-66]
```

